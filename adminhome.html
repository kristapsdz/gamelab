<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta charset="utf-8" /> 
		<title>Gamelab Administration</title>
		<link rel="stylesheet" href="@@cgibin@@/style.css" type="text/css" />
		<style>
			nav ul { list-style-type: none; 
				box-shadow: 2px 2px 4px #ccc;
				border-bottom: thin solid #aaa;
				background-color: #ccc; 
				padding: 0; 
				margin: 0; }
			nav li { display: inline-block; 
				font-size: 16pt; 
				padding: 1ex; }
			nav li:first-child { font-size: 18pt;
				color: #fff;
				background-color: #8888aa; }
			section { max-width: 1024px; 
				border: thin solid #aaa;
				margin: 1em auto 1em auto; }
			section ol { padding: 0; }
			section li { border: thin solid #ddd; 
				border-radius: 1ex;
				margin: 1em;
				margin-left: 2em;
				padding: 1ex; }
			section ol.default { list-style-type: none; }
			section ol.default li { font-style: italic;
				margin-left: 1em;
				color: #666; }
			fieldset { max-width: 1024px; 
				box-shadow: none; }
			.legend { background-color: #ddd; 
				border-right: thin solid #aaa;
				border-bottom: thin solid #aaa;
				color: #000; }
		</style>
		<script src="@@htdocs@@/script.js"></script>
		<script>
			function doHide(name) {
				var e;
				if (null != (e = document.getElementById(name)))
					e.style.display = 'none';
			}
			function doUnhide(name) {
				var e;
				if (null != (e = document.getElementById(name)))
					e.style.display = 'inherit';
			}

			function doSuccess(submitName, formName) {
				document.getElementById(submitName).value = 'Submit';
				document.getElementById(formName).reset();
			}
			function doError(err, submitName, errName) {
				document.getElementById(submitName).value = 'Submit';
				doUnhide(errName + (400 == err ? 'Form' : 'System'));
			}
			function doSetup(submitName, errName) {
				document.getElementById(submitName).value = 'Submitting...';
				doHide(errName + 'Form');
				doHide(errName + 'System');
			}

			function doAddPlayersSuccess(resp) {
				doSuccess('addPlayersSubmit', 'addPlayers');
			}
			function doChangeMailSuccess(resp) {
				doSuccess('changeMailSubmit', 'changeMail');
			}
			function doChangePassSuccess(resp) {
				doSuccess('changePassSubmit', 'changePass');
			}
			function doAddGameSuccess(resp) {
				doSuccess('addGameSubmit', 'addGame');
				loadGames();
			}
			function loadGamesSuccess(resp) {
				var i, j, k, results, li, e;

				if (null == (e = document.getElementById('loadGames')))
					return;

				while (e.firstChild)
					e.removeChild(e.firstChild);

				e.className = '';

				try  { 
					results = JSON.parse(resp);
				} catch (error) {
					li = document.createElement('li');
					li.appendChild(document.createTextNode('Parse error.'));
					e.appendChild(li);
					return;
				}

				for (i = 0; i < results.length; i++) {
					li = document.createElement('li');
					li.appendChild(document.createTextNode(results[i].name));
					li.appendChild(document.createTextNode(': {'));
					for (j = 0; j < results[i].payoffs.length; j++) {
						if (j > 0)
							li.appendChild(document.createTextNode(', '));
						li.appendChild(document.createTextNode('{'));
						for (k = 0; k < results[i].payoffs[j].length; k++) {
							if (k > 0)
								li.appendChild(document.createTextNode(', '));
							li.appendChild(document.createTextNode(results[i].payoffs[j][k]));
						}
						li.appendChild(document.createTextNode('}'));
					}
					li.appendChild(document.createTextNode('}'));
					e.appendChild(li);
				}
			}

			function doAddPlayersError(err) {
				doError(err, 'addPlayersSubmit', 'addPlayersErr');
			}
			function doChangeMailError(err) {
				doError(err, 'changeMailSubmit', 'changeMailErr');
			}
			function doChangePassError(err) {
				doError(err, 'changePassSubmit', 'changePassErr');
			}
			function doAddGameError(err) {
				doError(err, 'addGameSubmit', 'addGameErr');
			}
			function loadGamesError(err) {
				var li, e = document.getElementById('loadGames');
				if (null == e)
					return;
				while (e.firstChild)
					e.removeChild(e.firstChild);
				li = document.createElement('li');
				li.appendChild(document.createTextNode('An error occured.'));
				e.appendChild(li);
			}

			function doAddPlayersSetup() {
				doSetup('addPlayersSubmit', 'addPlayersErr');
			}
			function doChangeMailSetup() {
				doSetup('changeMailSubmit', 'changeMailErr');
			}
			function doChangePassSetup() {
				doSetup('changePassSubmit', 'changePassErr');
			}
			function doAddGameSetup() {
				doSetup('addGameSubmit', 'addGameErr');
			}

			function loadGames() {
				var xmlhttp, li, e;

				if (null == (e = document.getElementById('loadGames'))) 
					return;
				while (e.firstChild)
					e.removeChild(e.firstChild);

				e.className = 'default';
				li = document.createElement('li');
				li.appendChild(document.createTextNode('Loading...'));
				e.appendChild(li);

				xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange=function() {
					if (xmlhttp.readyState==4 && xmlhttp.status==200)
						loadGamesSuccess(xmlhttp.responseText);
					else if (xmlhttp.readyState == 4)
						loadGamesError(xmlhttp.status);
				} 
				xmlhttp.open('GET', '@@cgibin@@/doloadgames.json', true);
				xmlhttp.send(null);
			}
		</script>
	</head>
	<body onload="loadGames();">
		<nav>
			<ul>
				<li>Administrator</li>
				<li><a href="@@cgibin@@/dologout.html">Logout</a></li>
			</ul>
		</nav>
		<section>
			<div class="legend">
				Current Games
			</div>
			<ol id="loadGames" class="default">
				<li>Loading...</li>
			</ol>
		</section>
		<form action="@@cgibin@@/dochangemail.html" method="post" id="changeMail" onsubmit="return(sendForm(this, doChangeMailSetup, doChangeMailError, doChangeMailSuccess));">
			<fieldset>
				<div>
					<div class="legend">Change Administrator E-mail</div>
					<div class="error"><div id="changeMailErrSystem">An unexpected error occurred.</div></div>
					<div class="error"><div id="changeMailErrForm">Invalid new or existing e-mail address.</div></div>
				</div>
				<div class="fields">
					<input required="required" type="email" name="email1" placeholder="Existing E-mail"/>
					<input required="required" type="email" name="email2" placeholder="New E-mail"/>
					<input required="required" type="email" name="email3" placeholder="Repeat New E-mail"/>
					<input id="changeMailSubmit" type="submit" value="Submit" />
				</div>
			</fieldset>
		</form>
		<form action="@@cgibin@@/dochangepass.html" method="post" id="changePass" onsubmit="return(sendForm(this, doChangePassSetup, doChangePassError, doChangePassSuccess));">
			<fieldset>
				<div>
					<div class="legend">Change Administrator Password</div>
					<div class="error"><div id="changePassErrSystem">An unexpected error occurred.</div></div>
					<div class="error"><div id="changePassErrForm">Invalid new or existing password.</div></div>
				</div>
				<div class="fields">
					<input required="required" type="password" name="password1" placeholder="Existing Password"/>
					<input required="required" type="password" name="password2" placeholder="New Password"/>
					<input required="required" type="password" name="password3" placeholder="Repeat New Password"/>
					<input id="changePassSubmit" type="submit" value="Submit" />
				</div>
			</fieldset>
		</form>
		<form action="@@cgibin@@/doaddplayers.html" method="post" id="addPlayers" onsubmit="return(sendForm(this, doAddPlayersSetup, doAddPlayersError, doAddPlayersSuccess));">
			<fieldset>
				<div>
					<div class="legend">Add Players</div>
					<div class="error"><div id="addPlayersErrSystem">An unexpected system error occurred.</div></div>
				</div>
				<div class="fields">
					<div>
						Add players to the game using this form.
						Players consist of e-mail addresses separated by white-space (newlines, tabs, spaces, whatever).
						Once you submit, the players will be e-mailed a temporary password that they may use to log in to the system.
					</div>
					<textarea required="required" name="players" placeholder="Space-separated player e-mail addresses..."></textarea>
					<input id="addPlayersSubmit" type="submit" value="Submit" />
				</div>
			</fieldset>
		</form>
		<form action="@@cgibin@@/doaddgame.html" method="post" id="addGame" onsubmit="return(sendForm(this, doAddGameSetup, doAddGameError, doAddGameSuccess));">
			<fieldset>
				<div>
					<div class="legend">Add Game</div>
					<div class="error"><div id="addGameErrSystem">An unexpected system error occurred.</div></div>
					<div class="error"><div id="addGameErrForm">Invalid input.</div></div>
				</div>
				<div class="fields">
					<label>Strategies:</label>
					<input required="required" type="number" min="2" step="1" name="p1" value="2"/>,
					<input required="required" type="number" min="2" step="1" name="p2" value="2"/>
					<input required="required" type="text" name="name" placeholder="Game Name"/>
					<input required="required" type="text" name="payoffs" placeholder="Comma-separated values (top-left to bottom-right)"/>
					<input id="addGameSubmit" type="submit" value="Submit" />
				</div>
			</fieldset>
		</form>
	</body>
</html>
