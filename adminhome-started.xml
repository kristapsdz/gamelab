<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta charset="utf-8" /> 
		<title>Gamelab Administration</title>
		<link rel="stylesheet" href="@HTURI@/adminhome.css" type="text/css" />
		<link rel="stylesheet" href="@FONTURI@" type="text/css" />
		<script src="@HTURI@/script.min.js"></script>
		<script src="@HTURI@/adminhome.min.js"></script>
		<script src="@HTURI@/flotr2.min.js"></script>
	</head>
	<body onload="loadGames(); loadPlayers(); loadExpr(); loadSmtp();" onclick="onNavUp();">
		<header>
			<a id="navButton" href="#" onclick="return(onNav(event));"><i class="fa fa-navicon"></i></a>
			<h1>gamelab</h1>
			<span>
				Next round: <span id="exprCountdown"><i class="fa fa-spinner"></i></span>
			</span>
			<div id="navParent">
				<nav id="nav">
					<a href="@ADMINURI@/dologout.html"><i class="fa fa-sign-out"></i> Logout</a>
				</nav>
			</div>
		</header>
		<article class="top" id="statusExprLoading">
			<i class="fa fa-spinner fa-spin"></i>
			Loading interface...
		</article>
		<article class="top">
			<div class="statusgraph" id="statusExprGraph"></div>
			<div class="statusgraph" id="playerExprGraph"></div>
		</article>
		<article class="noshow" id="statusExprLoaded">
			<section>
				<p>
					Your experiment has <span id="statusExprPPmax"></span> rounds per player, with each round taking
					<span id="statusExprMins"></span> minutes.
					<span id="statusExprRoundpcting">
						If each player role has at least <span id="statusExprRoundpct"></span>% plays, the round
						will advance (with <span id="statusExprRoundmin"></span> minutes of grace time).
					</span>
				</p>
				<p id="mturkbox">
					Your Mechanical Turk request (access key <code id="awsaccesskey">asdf</code>) is still being processed.
				</p>
				<p id="mturkokbox">
					This is a Mechanical Turk experiment with HIT identifier
					<code id="hitid"></code> in
					<span id="mturksandbox">sandbox</span>
					<span id="mturknosandbox">production (non-sandbox)</span> mode.
				</p>
				<p id="statusExprHasLobby">
					Players waiting in the lobby: <span id="statusExprLobbysize"></span>.
				</p>
				<div id="statusExprProg">
					<div class="statuslistbox" id="statusHighestBox">
						<div class="statuslistcaption">Last Round Highest Earners (<a href="@ADMINURI@/dogethighest.csv">CSV</a>)</div>
						<ul class="statuslist" id="statusHighest"></ul>
					</div>
					<div class="table">
						<div>
							<div class="table-left-head">
								Round <span id="statusExprPRound"></span>/<span id="statusExprPMax"></span> 
							</div>
							<div><progress max="1.0" id="statusExprPBar"></progress></div>
						</div>
						<div>
							<div class="table-left-head">
								Row plays 
								<span id="statusExprFrow"></span>/<span id="statusExprFrowMax"></span>
							</div>
							<div><progress max="1.0" id="statusExprFrowPct"></progress></div>
						</div>
						<div>
							<div class="table-left-head">
								Column plays
								<span id="statusExprFcol"></span>/<span id="statusExprFcolMax"></span>
							</div>
							<div><progress max="1.0" id="statusExprFcolPct"></progress></div>
						</div>
					</div>
					<div id="noplayers" class="noshow">
						<div class="warning">
							<div>
								<div><i class="fa fa-exclamation-circle"></i></div>
								<div>
									There are zero players in one of the player roles: no payoffs can be
									computed in this round.
								</div>
							</div>
						</div>
					</div>
				</div>
				<p id="statusMailer">
					The mailer is <i>running</i>: process ID <span id="statusMailerPid"></span>
					(process is <span id="statusMailerPidOk">ok</span><i id="statusMailerPidBad">zombied</i>).
				</p>
				<div id="statusExprWaiting">
					<div class="table">
						<div>
							<div class="table-left-head">
								Round <i>pre-game</i>
							</div>
							<div><progress></progress></div>
						</div>
					</div>
				</div>
				<div id="statusExprFinished">
					<div class="table">
						<div>
							<div class="table-left-head">
								Round <i>finished</i>
							</div>
							<div><progress></progress></div>
						</div>
					</div>
					<div class="statuslistbox">
						<div class="statuslistcaption">Last Round Highest Earners (<a href="@ADMINURI@/dogethighest.csv">CSV</a>)</div>
						<ul class="statuslist" id="statusHighest2"></ul>
					</div>
					<div class="statuslistbox" id="statusExprFinishedWinnersBox">
						<div class="statuslistcaption">Lottery Winner(s)</div>
						<ul class="statuslist" id="statusExprFinishedWinners"></ul>
					</div>
					<div id="statusExprFinishedWin">
						<p>
							First you must compute winnings by entering <i class="fa fa-cubes"></i> a numeric random seed
							used to pick winners and <i class="fa fa-trophy"></i> the number of winners to choose.
						</p>
						<div class="error noshow" id="statusExprFinishedWinError">
							An error occurred: the experiment hasn't begun, hasn't ended, or has zero tickets.
						</div>
						<div class="error noshow" id="statusExprFinishedWinForm">
							Malformed input: try again.
						</div>
						<form action="@ADMINURI@/dowinners.json" method="post" onsubmit="return(sendWinners(this));">
							<fieldset>
								<div class="input">
									<i class="fa fa-fw fa-cubes"></i>
									<input type="text" name="winseed" placeholder="Random Seed" required="required" />
								</div>
								<div class="input">
									<i class="fa fa-fw fa-users"></i>
									<input type="number" min="1" name="winners" value="1" required="required" />
								</div>
								<div class="input input-submit">
									<i class="fa fa-fw fa-trophy"></i>
									<input type="submit" id="winnersButton" value="Compute Winners" />
								</div>
							</fieldset>
						</form>
					</div>
				</div>
			</section>
			<section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Experiment Control</span>
					</h3>
					<div>
						Control the progress of your experiment here.  <strong>Warning</strong>: this may affect the
						state of your experiment, so be careful!  To perform any action, first
						<span id="wipeExprCheckboxBox">
							<input id="wipeExprCheckbox" type="checkbox" onclick="checkWipeButton(this);" />
							<label for="wipeExprCheckbox">verify</label>
						</span>
						that you're serious about doing this.
					</div>
					<div>
						Backing up involves creating a redacted copy of the database on disc.  If e-mail has been
						configured, the back-up is then e-mailed to the administrator.
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-fw fa-database"></i>
							<button type="button" id="backupButton" onclick="backup();" disabled="disabled">Backup Experiment</button>
						</div>
					</fieldset>
					<div>
						When you wipe, the experiment is backed-up, conditionally e-mailed, then its data wiped (though
						some components, such as the games, remain).  To hard-wipe is the same as wiping, but the
						experiment is neither backed up nor e-mailed.
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-fw fa-recycle"></i>
							<button type="button" id="wipeExprButton" onclick="wipeExpr();" disabled="disabled">Wipe Experiment</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-fw fa-refresh"></i>
							<button type="button" id="wipeCleanExprButton" onclick="wipeCleanExpr();" disabled="disabled">Hard-Wipe Experiment</button>
						</div>
					</fieldset>
					<div>
						Lastly, you may advance the current round of your experiment or advance to the last round,
						effectively ending the experiment.  (The current round may not be the round you're
						reading&#8212;refresh this page to double-check.)
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-fw fa-arrow-circle-o-right"></i>
							<button type="button" id="advanceButton" onclick="advanceRound();" disabled="disabled">Advance Round</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-fw fa-arrow-circle-o-right"></i>
							<button type="button" id="advanceEndButton" onclick="advanceEndRound();" disabled="disabled">Advance To Last Round</button>
						</div>
					</fieldset>
					<p>
						You can also fetch a copy of the <a href="@ADMINURI@/dogethistory.json">history JSON</a> or the
						source for the current version of <span class="nm">gamelab</span>, version <a
							href="http://www.kcons.eu/gamelab/snapshots/gamelab-@VERSION@.tgz">@VERSION@</a>.
					</p>
					<div id="wipeExprResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						<p>
							The database is being backed up and wiped.
							Please wait a little bit, then reload.
						</p>
					</div>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Experiment Games</span>
					</h3>
					<div>
						<ul id="loadGames">
							<li><i class="fa fa-spinner"></i></li>
						</ul>
					</div>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Experiment Players</span>
					</h3>
					<div>
						Players in your experiment.
						Click on a player to see their status.
						Enable or disable a player by flipping the toggle icon.
						Players may be in the <i class="fa fa-bars"></i> row role or <i class="fa fa-columns"></i>
						column role.
						However, they may also be in the <i class="fa fa-spinner"></i> lobby, in which case they are not
						yet assigned a role.
						Players also may be <i class="fa fa-thumb-tack"></i> captive or
						<i class="fa fa-amazon"></i> Mechanical Turk workers.
					</div>
					<div>
						<ul id="loadPlayers">
							<li><i class="fa fa-spinner"></i></li>
						</ul>
					</div>
					<div id="playerInfo" class="canclose noshow">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						<p>
							<span id="playerInfoEmail"></span>: 
							<span id="playerInfoStatus"></span>, 
							<span id="playerInfoEnabled"></span>
							(joined round <span id="playerInfoJoined"></span>, answered <span id="playerInfoAnswer"></span> questions)
						</p>
						<form action="@ADMINURI@/doresetpasswords.json" method="post" onsubmit="return(resetPass(this));">
							<input type="hidden" id="playerInfoId" name="pid" />
							<fieldset>
								<div class="input input-submit">
									<i class="fa fa-send"></i>
									<input type="submit" id="resetPasswordButton" value="Reset Password" />
								</div>
							</fieldset>
						</form>
					</div>
					<div>
						Reset all players' passwords by clicking the button.
						This will not contact the players: it will only reset the password.
						Reconfiguring involves setting the password on newly-added players (and e-mailing them, if a
						e-mail server has been specified) or players whose prior configuration failed due to a bad
						e-mail server.
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="resetPasswordButton" onclick="resetPasswords();">Reset passwords</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="recheckSmtpButton" onclick="reTestSmtp();">Reconfigure</button>
						</div>
					</fieldset>
					<div>
						Add players to the game using this form.
						Players consist of e-mail addresses separated by white-space (newlines, tabs, spaces, whatever).
						When you're finished adding all players, you must reconfigure.
					</div>
					<form action="@ADMINURI@/doaddplayers.json" method="post" id="addPlayers" onsubmit="return(addPlayers(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-users"></i>
								<textarea name="players" placeholder="Space-separated player e-mail addresses..."></textarea>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="addPlayersSubmit" type="submit" value="Submit" />
							</div>
						</fieldset>
						<input type="hidden" id="autoadd2" name="autoadd" value="0" />
					</form>
					<div>
						If you set the <q>Allow Captive Players</q> toggle, then players may add themselves.
						Captive players will not be e-mailed when the experiment is started, nor will they be remembered
						when the experiment is wiped.
					</div>
					<form action="@ADMINURI@/doaddplayers.json" method="post" id="addPlayers2" onsubmit="return(addPlayers2(this));">
						<fieldset>
							<div class="input input-check">
								<i onclick="toggler('autoadd', 'autoaddToggle');" id="autoaddToggle" class="fa fa-fw fa-toggle-off"></i>
								<span onclick="toggler('autoadd', 'autoaddToggle');">Allow Captive Players</span>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="addPlayersSubmit2" type="submit" value="Submit" />
							</div>
							<input type="hidden" id="autoadd" name="autoadd" value="0" />
						</fieldset>
					</form>
					<div id="captiveGame">
						<strong>Note</strong>: you have opted for a captive experiment.
						To enter the captive portal, your players will need to access <a
							href="@HTURI@/playerautoadd.html">@HTURI@/playerautoadd.html</a> in order to log in.
					</div>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Change Instructions</span>
					</h3>
					<div>
						You may change the experiment instructions here.
						<b>Warning</b>: this means that you've already messed up.
						Be very, very careful about what you do here: you are changing a live experiment!
					</div>
					<div class="error noshow" id="changeInstrErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeInstrErrForm">
						Invalid instructions.
					</div>
					<div class="error noshow" id="changeInstrErrState">
						Experiment has already ended&mdash;what's the point?
					</div>
					<form action="@ADMINURI@/dosetinstr.json" method="post" id="changeInstr" onsubmit="return(changeInstr(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-code"></i>
								<textarea id="instr" class="bigtext" required="required" name="instr"></textarea>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeInstrSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Change E-mail</span>
					</h3>
					<div>
						You should set the e-mail address to your address, as the system (or system administrator) will
						mail you if it has issues.
						You will be logged out after doing so.
					</div>
					<div class="error noshow" id="changeMailErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeMailErrForm">
						Invalid new or existing e-mail address.
					</div>
					<form action="@ADMINURI@/dochangemail.json" method="post" id="changeMail" onsubmit="return(changeMail(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email1" placeholder="Existing E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email2" placeholder="New E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email3" placeholder="Repeat New E-mail"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeMailSubmit" type="submit" value="Submit" gamelab-submit-pending="Starting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>Change Password</span>
					</h3>
					<div>
						Set your password (at least one character) here.
						You should do this when you first use the system, as the default is too easy.
						It's up to you to make sure your password is secure.
						You will be logged out after doing so.
					</div>
					<div class="error noshow" id="changePassErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changePassErrForm">
						Invalid new or existing password.
					</div>
					<form action="@ADMINURI@/dochangepass.json" method="post" id="changePass" onsubmit="return(changePass(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password1" placeholder="Existing Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password2" placeholder="New Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password3" placeholder="Repeat New Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changePassSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						<span>E-Mail Server</span>
					</h3>
					<div>
						In order to send e-mails to players, you need to configure a valid e-mail sending
						service.
						If you mess up, you can always fix this information after the game starts and re-try e-mails
						that failed to send.
					</div>
					<div id="checkSmtpResults" class="noshow">
						<div>
							The following are your SMTP parameters.
							Click <q>Send Test</q> to send a test message to the administrator account
							(<em>not</em> the <q>from address</q>!).
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input disabled="disabled" id="checkSmtpResultsServer" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input disabled="disabled" id="checkSmtpResultsUser" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input disabled="disabled" id="checkSmtpResultsFrom" type="text" />
							</div>
							<div class="input input-submit">
								<i class="fa fa-send"></i>
								<button type="button" class="send" id="checkSmtpButton" onclick="testSmtp();">Send Test</button>
							</div>
						</fieldset>
					</div>
					<div id="testSmtpResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						<p>
							A test e-mail has been sent to <span id="testSmtpResultsMail"></span>.
							If you do not receive it in a little while, please fix your mail settings.
						</p>
					</div>
					<div>
						The e-mail address <i class="fa fa-envelope"></i> will appear as the <q>from</q> address
						on all e-mails the system sends out.
						Make sure this is a real address so participants can write to you!
						The server <i class="fa fa-database"></i> is your SMTP server.
						It must be encrypted (SSL/TLS), and be in the form
						<q>smtp://the.server.name:port</q>, where the port is usually 25, 465, or 587.
						(It can be anything, though.)
						The username <i class="fa fa-user"></i> and password <i class="fa fa-lock"></i> are used
						to log into your server.
						<em>Your password is stored on the gamelab server</em>:
						make sure it's something random and not used elsewhere!
					</div>
					<div class="error noshow" id="changeSmtpErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeSmtpErrForm">
						Invalid new or existing parameters.
					</div>
					<form action="@ADMINURI@/dochangesmtp.json" method="post" id="changeSmtp" onsubmit="return(changeSmtp(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email" placeholder="you@example.com"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input required="required" type="text" name="server" placeholder="smtp://example.com:587"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input required="required" type="text" name="user" placeholder="SMTP User"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password" placeholder="SMTP Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeSmtpSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
			</section>
		</article>
		<footer>
			&copy; 2014, 2015 
			<a href="http://www.kcons.eu"><i>k</i>-Consulting</a>
			<a href="http://www.kcons.eu/gamelab">gamelab @VERSION@</a>
			<a href="@HTURI@/privacy.html">Privacy</a>
		</footer>
	</body>
</html>
