<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta charset="utf-8" /> 
		<title>Gamelab Administration</title>
		<link rel="stylesheet" href="@HTURI@/style.css" type="text/css" />
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
		<script src="@HTURI@/script.js"></script>
		<script src="@HTURI@/adminhome.js"></script>
	</head>
	<body onload="loadGames(); loadPlayers(); loadExpr(); loadSmtp();" onclick="onNavUp();">
		<header>
			<a id="navButton" href="#" onclick="return(onNav(event));"><i class="fa fa-navicon"></i></a>
			<h1>gamelab</h1>
			<span>
				Next round: <span id="exprCountdown"><i class="fa fa-spinner fa-spin"></i></span>
			</span>
			<div id="navParent">
				<nav id="nav">
					<ul>
						<li><a href="@ADMINURI@/dologout.html"><i class="fa fa-sign-out"></i> Logout</a></li>
					</ul>
				</nav>
			</div>
		</header>
		<article>
			<section>
				<section id="statusExpr">
					<h3>Experiment Status</h3>
					<div id="statusExprProg">
						<div>
							Round: <span id="statusExprPRound"></span>/<span id="statusExprPMax"></span>
						</div>
						<progress max="1.0" id="statusExprPBar"></progress>
						<div class="tabled">
							<div>
								<div>Complete row plays:</div>
								<div id="statusExprFrow"></div>
							</div>
							<div>
								<div>Complete column plays:</div>
								<div id="statusExprFcol"></div>
							</div>
						</div>
						<div class="tabled" id="statusExprPGames">
						</div>
					</div>
					<div id="statusExprWaiting">
						Waiting for experiment to begin.
					</div>
					<div id="statusExprFinished">
						<p>
							Your experiment has finished.
							What follows are the winners and their rankings.
						</p>
						<ul id="statusExprFinishedWinners"></ul>
						<form id="statusExprFinishedWin" action="@ADMINURI@/dowinners.json" method="post" onsubmit="return(sendWinners(this));">
							<aside>
								<div>
									You may now compute winnings.
								</div>
							</aside>
							<div class="error">
								<div class="noshow" id="statusExprFinishedWinError">
									An error occurred: the experiment hasn't begun, hasn't ended, or has zero tickets.
								</div>
								<div class="noshow" id="statusExprFinishedWinForm">
									Malformed input: try again.
								</div>
							</div>
							<fieldset>
								<div class="input">
									<i class="fa fa-fw fa-cubes"></i>
									<input type="text" name="winseed" placeholder="Random Seed" required="required" />
								</div>
								<div class="input">
									<i class="fa fa-fw fa-users"></i>
									<input type="number" min="1" name="winners" value="1" required="required" />
								</div>
								<div class="input input-submit">
									<i class="fa fa-fw fa-trophy"></i>
									<input type="submit" id="winnersButton" value="Compute Winners" />
								</div>
							</fieldset>
						</form>
						<div>
							You can now download and analyse the results, and players can still log in and see their
							play history.
						</div>
					</div>
					<div id="statusExprLoading">
						<i class="fa fa-spinner fa-spin"></i>
					</div>
					<aside>
						You may backup or wipe the database by clicking the button below.
						When you back up, the <a href="#changeMailSection">administrator</a> is mailed a redacted copy of the database.
						Wiping will delete all but the SMTP configuration, list of players, and list of games.
						(Wiping will trigger the backup as well.)
						You must verify that you really, really want to wipe by clicking the
						<div id="wipeExprCheckbox"><input type="checkbox" onclick="checkWipeButton(this);" /> checkbox</div>.
					</aside>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-fw fa-recycle"></i>
							<button type="button" id="wipeExprButton" onclick="wipeExpr();" disabled="disabled">Wipe Experiment</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-fw fa-database"></i>
							<button type="button" id="backupButton" onclick="backup();">Backup Experiment</button>
						</div>
					</fieldset>
					<div id="wipeExprResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						The database is being backed up and wiped.
						Please wait a little bit, then <a href="#" onclick="window.location.reload(true);">reload</a>.
					</div>
				</section>
				<section>
					<h3>Experiment Games</h3>
					<ul id="loadGames">
						<li><i class="fa fa-spinner fa-spin"></i></li>
					</ul>
				</section>
				<section>
					<h3>Experiment Players</h3>
					<aside>
						Players in your experiment.
						Click on a player to see their status.
						Enable or disable a player by toggling the icon.
						Row players are noted with <i class="fa fa-bars"></i>, column players with
						<i class="fa fa-columns"></i>.
					</aside>
					<ul id="loadPlayers">
						<li><i class="fa fa-spinner fa-spin"></i></li>
					</ul>
					<div id="playerInfo" class="canclose noshow">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						<span id="playerInfoEmail"></span>: 
						<span id="playerInfoStatus"></span>, 
						<span id="playerInfoEnabled"></span>
						<form action="@ADMINURI@/doresetpasswords.json" method="post" onsubmit="return(resetPass(this));">
							<input type="hidden" id="playerInfoId" name="pid" />
							<fieldset>
								<div class="input input-submit">
									<i class="fa fa-send"></i>
									<input type="submit" id="resetPasswordButton" value="Reset Password" />
								</div>
							</fieldset>
						</form>
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="resetPasswordButton" onclick="resetPasswords();">Reset All Passwords</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="recheckSmtpButton" onclick="reTestSmtp();">Resend Error Mails</button>
						</div>
					</fieldset>
				</section>
				<section id="changeInstrSection">
					<h3>Change Instructions</h3>
					<aside>
						You may change the experiment instructions here.
						<b>Warning</b>: this means that you've already messed up.
						Be very, very careful about what you do here: you are changing a live experiment!
					</aside>
					<form action="@ADMINURI@/dosetinstr.json" method="post" id="changeInstr" onsubmit="return(changeInstr(this));">
						<div class="error">
							<div class="noshow" id="changeInstrErrSystem">
								An unexpected error occurred.
							</div>
							<div class="noshow" id="changeInstrErrForm">
								Invalid instructions.
							</div>
							<div class="noshow" id="changeInstrErrState">
								Experiment has already ended&mdash;what's the point?
							</div>
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-code"></i>
								<textarea id="instr" class="bigtext" required="required" name="instr"></textarea>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-code"></i>
								<textarea id="instrWin" required="required" name="instrWin"></textarea>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeInstrSubmit" type="submit" value="Submit" />
							</div>
						</fieldset>
					</form>
				</section>
				<section id="changeMailSection">
					<h3>Change E-mail</h3>
					<aside>
						You should set the e-mail address to your address, as the system (or system administrator) will
						mail you if it has issues.
						You will be logged out after doing so.
					</aside>
					<form action="@ADMINURI@/dochangemail.json" method="post" id="changeMail" onsubmit="return(changeMail(this));">
						<div class="error">
							<div class="noshow" id="changeMailErrSystem">
								An unexpected error occurred.
							</div>
							<div class="noshow" id="changeMailErrForm">
								Invalid new or existing e-mail address.
							</div>
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email1" placeholder="Existing E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email2" placeholder="New E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email3" placeholder="Repeat New E-mail"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeMailSubmit" type="submit" value="Submit" />
							</div>
						</fieldset>
					</form>
				</section>
				<section id="changePassSection">
					<h3>Change Password</h3>
					<aside>
						Set your password (at least one character) here.
						You should do this when you first use the system, as the default is too easy.
						It's up to you to make sure your password is secure.
						You will be logged out after doing so.
					</aside>
					<form action="@ADMINURI@/dochangepass.json" method="post" id="changePass" onsubmit="return(changePass(this));">
						<div class="error">
							<div class="noshow" id="changePassErrSystem">
								An unexpected error occurred.
							</div>
							<div class="noshow" id="changePassErrForm">
								Invalid new or existing password.
							</div>
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password1" placeholder="Existing Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password2" placeholder="New Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password3" placeholder="Repeat New Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changePassSubmit" type="submit" value="Submit" />
							</div>
						</fieldset>
					</form>
				</section>
				<section id="changeSmtpSection">
					<h3>Change SMTP</h3>
					<aside>
						In order to send e-mails to players, you need to configure a valid e-mail sending
						service.
						If you mess up, you can always fix this information after the game starts and re-try e-mails
						that failed to send.
					</aside>
					<div id="checkSmtpResults" class="noshow">
						<h4>Current Values</h4>
						<aside>
							<div>
								The following are your SMTP parameters.
								Click <q>Send Test</q> to send a test message to the administrator account
								(<em>not</em> the <q>from address</q>!).
							</div>
						</aside>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input disabled="disabled" id="checkSmtpResultsServer" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input disabled="disabled" id="checkSmtpResultsUser" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input disabled="disabled" id="checkSmtpResultsFrom" type="text" />
							</div>
							<div class="input input-submit">
								<i class="fa fa-send"></i>
								<button type="button" class="send" id="checkSmtpButton" onclick="testSmtp();">Send Test</button>
							</div>
						</fieldset>
					</div>
					<div id="testSmtpResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						A test e-mail has been sent to <span id="testSmtpResultsMail"></span>.
						If you do not receive it in a little while, please fix your mail settings.
					</div>
					<div id="checkSmtpResultsNone" class="noshow error">
						<i class="fa fa-warning"></i>
						<span>You have not yet configured your e-mail server.</span>
					</div>
					<div id="checkSmtpResultsLoad">
						<i class="fa fa-spinner fa-spin"></i>
					</div>
					<aside>
						<div>
							The e-mail address <i class="fa fa-envelope"></i> will appear as the <q>from</q> address
							on all e-mails the system sends out.
							Make sure this is a real address so participants can write to you!
							The server <i class="fa fa-database"></i> is your SMTP server.
							It must be encrypted (SSL/TLS), and be in the form
							<q>smtp://the.server.name:port</q>, where the port is usually 25, 465, or 587.
							(It can be anything, though.)
							The username <i class="fa fa-user"></i> and password <i class="fa fa-lock"></i> are used
							to log into your server.
							<em>Your password is stored on the gamelab server</em>:
							make sure it's something random and not used elsewhere!
						</div>
					</aside>
					<form action="@ADMINURI@/dochangesmtp.json" method="post" id="changeSmtp" onsubmit="return(changeSmtp(this));">
						<div class="error">
							<div class="noshow" id="changeSmtpErrSystem">
								An unexpected error occurred.
							</div>
							<div class="noshow" id="changeSmtpErrForm">
								Invalid new or existing parameters.
							</div>
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email" placeholder="you@example.com"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input required="required" type="text" name="server" placeholder="smtp://example.com:587"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input required="required" type="text" name="user" placeholder="SMTP User"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password" placeholder="SMTP Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeSmtpSubmit" type="submit" value="Submit" />
							</div>
						</fieldset>
					</form>
				</section>
			</section>
		</article>
		<footer>
			&copy; 2014, 
			<a href="http://www.kcons.eu"><i>k</i>-Consulting</a>
			<a href="@HTURI@/privacy.html">Privacy</a>
		</footer>
	</body>
</html>
