<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta charset="utf-8" /> 
		<title>Gamelab Administration</title>
		<link rel="stylesheet" href="@HTURI@/adminhome.css" type="text/css" />
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
		<script src="@HTURI@/script.js"></script>
		<script src="@HTURI@/adminhome.js"></script>
	</head>
	<body onload="loadGames(); loadPlayers(); loadExpr(); loadSmtp();" onclick="onNavUp();">
		<header>
			<a id="navButton" href="#" onclick="return(onNav(event));"><i class="fa fa-navicon"></i></a>
			<h1>gamelab</h1>
			<span>
				Next round: <span id="exprCountdown"><i class="fa fa-spinner"></i></span>
			</span>
			<div id="navParent">
				<nav id="nav">
					<a href="@ADMINURI@/dologout.html"><i class="fa fa-sign-out"></i> Logout</a>
				</nav>
			</div>
		</header>
		<article>
			<section class="intro">
				<div id="statusExprProg">
					<p>
						Welcome!  Your experiment is in round 
						<span id="statusExprPRound"></span> of <span id="statusExprPMax"></span>.
					</p>
					<progress max="1.0" id="statusExprPBar"></progress>
					<div class="table">
						<div>
							<div class="table-left-head">Complete row plays:</div>
							<div id="statusExprFrow"></div>
						</div>
						<div>
							<div class="table-left-head">Complete column plays:</div>
							<div id="statusExprFcol"></div>
						</div>
					</div>
					<div class="table" id="statusExprPGames">
					</div>
					<div class="input input-submit">
						<i class="fa fa-fw fa-arrow-circle-o-right"></i>
						<button type="button" onclick="advanceRound();">Advance Round</button>
					</div>
				</div>
				<div id="statusExprWaiting">
					<p>
						Welcome!  Waiting for experiment to begin...
					</p>
				</div>
				<div id="statusExprFinished">
					<p>
						Welcome!  Your experiment has finished.
						What follows are the winners and their rankings.
					</p>
					<ul id="statusExprFinishedWinners"></ul>
					<div id="statusExprFinishedWin">
						<div>
							You may now compute winnings.
						</div>
						<div class="error noshow" id="statusExprFinishedWinError">
							An error occurred: the experiment hasn't begun, hasn't ended, or has zero tickets.
						</div>
						<div class="error noshow" id="statusExprFinishedWinForm">
							Malformed input: try again.
						</div>
						<form action="@ADMINURI@/dowinners.json" method="post" onsubmit="return(sendWinners(this));">
							<fieldset>
								<div class="input">
									<i class="fa fa-fw fa-cubes"></i>
									<input type="text" name="winseed" placeholder="Random Seed" required="required" />
								</div>
								<div class="input">
									<i class="fa fa-fw fa-users"></i>
									<input type="number" min="1" name="winners" value="1" required="required" />
								</div>
								<div class="input input-submit">
									<i class="fa fa-fw fa-trophy"></i>
									<input type="submit" id="winnersButton" value="Compute Winners" />
								</div>
							</fieldset>
						</form>
					</div>
					<div>
						You can now download and analyse the results, and players can still log in and see their
						play history.
					</div>
				</div>
				<div id="statusExprLoading">
					<p>
						<i class="fa fa-spinner"></i>
					</p>
				</div>
			</section>
			<section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> Experiment Control</h3>
					<div>
						Backup or wipe the database by clicking the button below.
						When you back up, you're e-mailed a redacted copy of the database.
						When you wipe, the experiment data (but not configuration) is wiped.
						Wiping will trigger a backup as well.
					</div>
					<div>
						To wipe, first verify that you really intend to do this by clicking the
						<span id="wipeExprCheckbox"><input type="checkbox" onclick="checkWipeButton(this);" /> checkbox</span>.
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-fw fa-recycle"></i>
							<button type="button" id="wipeExprButton" onclick="wipeExpr();" disabled="disabled">Wipe Experiment</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-fw fa-database"></i>
							<button type="button" id="backupButton" onclick="backup();">Backup Experiment</button>
						</div>
					</fieldset>
					<div id="wipeExprResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						The database is being backed up and wiped.
						Please wait a little bit, then reload.
					</div>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> Experiment Games</h3>
					<ul id="loadGames">
						<li><i class="fa fa-spinner"></i></li>
					</ul>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						Experiment Players
					</h3>
					<div>
						Players in your experiment.
						Click on a player to see their status.
						Enable or disable a player by toggling the icon.
						Row players are noted with <i class="fa fa-bars"></i>, column players with
						<i class="fa fa-columns"></i>.
					</div>
					<ul id="loadPlayers">
						<li><i class="fa fa-spinner"></i></li>
					</ul>
					<div id="playerInfo" class="canclose noshow">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						<div>
							<span id="playerInfoEmail"></span>: 
							<span id="playerInfoStatus"></span>, 
							<span id="playerInfoEnabled"></span>
						</div>
						<form action="@ADMINURI@/doresetpasswords.json" method="post" onsubmit="return(resetPass(this));">
							<input type="hidden" id="playerInfoId" name="pid" />
							<fieldset>
								<div class="input input-submit">
									<i class="fa fa-send"></i>
									<input type="submit" id="resetPasswordButton" value="Reset Password" />
								</div>
							</fieldset>
						</form>
					</div>
					<fieldset>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="resetPasswordButton" onclick="resetPasswords();">Reset All Passwords</button>
						</div>
						<div class="input input-submit">
							<i class="fa fa-send"></i>
							<button type="button" id="recheckSmtpButton" onclick="reTestSmtp();">Resend Error Mails</button>
						</div>
					</fieldset>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						Change Instructions
					</h3>
					<div>
						You may change the experiment instructions here.
						<b>Warning</b>: this means that you've already messed up.
						Be very, very careful about what you do here: you are changing a live experiment!
					</div>
					<div class="error noshow" id="changeInstrErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeInstrErrForm">
						Invalid instructions.
					</div>
					<div class="error noshow" id="changeInstrErrState">
						Experiment has already ended&mdash;what's the point?
					</div>
					<form action="@ADMINURI@/dosetinstr.json" method="post" id="changeInstr" onsubmit="return(changeInstr(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-code"></i>
								<textarea id="instr" class="bigtext" required="required" name="instr"></textarea>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-code"></i>
								<textarea id="instrWin" required="required" name="instrWin"></textarea>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeInstrSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						Change E-mail
					</h3>
					<div>
						You should set the e-mail address to your address, as the system (or system administrator) will
						mail you if it has issues.
						You will be logged out after doing so.
					</div>
					<div class="error noshow" id="changeMailErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeMailErrForm">
						Invalid new or existing e-mail address.
					</div>
					<form action="@ADMINURI@/dochangemail.json" method="post" id="changeMail" onsubmit="return(changeMail(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email1" placeholder="Existing E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email2" placeholder="New E-mail"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope-o"></i>
								<input required="required" type="email" name="email3" placeholder="Repeat New E-mail"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeMailSubmit" type="submit" value="Submit" gamelab-submit-pending="Starting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						Change Password
					</h3>
					<div>
						Set your password (at least one character) here.
						You should do this when you first use the system, as the default is too easy.
						It's up to you to make sure your password is secure.
						You will be logged out after doing so.
					</div>
					<div class="error noshow" id="changePassErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changePassErrForm">
						Invalid new or existing password.
					</div>
					<form action="@ADMINURI@/dochangepass.json" method="post" id="changePass" onsubmit="return(changePass(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password1" placeholder="Existing Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password2" placeholder="New Password"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password3" placeholder="Repeat New Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changePassSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
				<section class="rolled">
					<h3 onclick="unroll(this.firstChild, this.parentNode);"><i class="fa fa-fw fa-chevron-circle-right"></i> 
						Change SMTP
					</h3>
					<div>
						In order to send e-mails to players, you need to configure a valid e-mail sending
						service.
						If you mess up, you can always fix this information after the game starts and re-try e-mails
						that failed to send.
					</div>
					<div id="checkSmtpResults" class="noshow">
						<div>
							The following are your SMTP parameters.
							Click <q>Send Test</q> to send a test message to the administrator account
							(<em>not</em> the <q>from address</q>!).
						</div>
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input disabled="disabled" id="checkSmtpResultsServer" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input disabled="disabled" id="checkSmtpResultsUser" type="text" />
							</div>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input disabled="disabled" id="checkSmtpResultsFrom" type="text" />
							</div>
							<div class="input input-submit">
								<i class="fa fa-send"></i>
								<button type="button" class="send" id="checkSmtpButton" onclick="testSmtp();">Send Test</button>
							</div>
						</fieldset>
					</div>
					<div id="testSmtpResults" class="noshow canclose">
						<a href="#" class="close" onclick="doHideNode(this.parentNode); return false;"><i class="fa fa-minus-square"></i></a>
						A test e-mail has been sent to <span id="testSmtpResultsMail"></span>.
						If you do not receive it in a little while, please fix your mail settings.
					</div>
					<div>
						The e-mail address <i class="fa fa-envelope"></i> will appear as the <q>from</q> address
						on all e-mails the system sends out.
						Make sure this is a real address so participants can write to you!
						The server <i class="fa fa-database"></i> is your SMTP server.
						It must be encrypted (SSL/TLS), and be in the form
						<q>smtp://the.server.name:port</q>, where the port is usually 25, 465, or 587.
						(It can be anything, though.)
						The username <i class="fa fa-user"></i> and password <i class="fa fa-lock"></i> are used
						to log into your server.
						<em>Your password is stored on the gamelab server</em>:
						make sure it's something random and not used elsewhere!
					</div>
					<div class="error noshow" id="changeSmtpErrSystem">
						An unexpected error occurred.
					</div>
					<div class="error noshow" id="changeSmtpErrForm">
						Invalid new or existing parameters.
					</div>
					<form action="@ADMINURI@/dochangesmtp.json" method="post" id="changeSmtp" onsubmit="return(changeSmtp(this));">
						<fieldset>
							<div class="input">
								<i class="fa fa-fw fa-envelope"></i>
								<input required="required" type="email" name="email" placeholder="you@example.com"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-database"></i>
								<input required="required" type="text" name="server" placeholder="smtp://example.com:587"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-user"></i>
								<input required="required" type="text" name="user" placeholder="SMTP User"/>
							</div>
							<div class="input">
								<i class="fa fa-fw fa-lock"></i>
								<input required="required" type="password" name="password" placeholder="SMTP Password"/>
							</div>
							<div class="input input-submit">
								<i class="fa fa-fw fa-check"></i>
								<input id="changeSmtpSubmit" type="submit" value="Submit" gamelab-submit-pending="Submitting..." />
							</div>
						</fieldset>
					</form>
				</section>
			</section>
		</article>
		<footer>
			&copy; 2014, 2015
			<a href="http://www.kcons.eu"><i>k</i>-Consulting</a>
			<a href="@HTURI@/privacy.html">Privacy</a>
		</footer>
	</body>
</html>
